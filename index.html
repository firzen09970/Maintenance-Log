<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>115å¹´ è£å‚™ç®¡åˆ¶ (Lite)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f3f4f6; padding-bottom: 40px; }
        
        /* Category Colors - Specific for Border Left & Text */
        /* å…µå™¨ - ç´… */
        .theme-weap { --main-col: #ef4444; --bg-col: #fef2f2; --text-col: #991b1b; } 
        /* é€šä¿¡ - è— */
        .theme-comm { --main-col: #0ea5e9; --bg-col: #e0f2fe; --text-col: #075985; }
        /* åŒ–å­¸ - é’ */
        .theme-chem { --main-col: #14b8a6; --bg-col: #ccfbf1; --text-col: #115e59; }
        /* è¼ªè»Š - ç° */
        .theme-truck { --main-col: #64748b; --bg-col: #f1f5f9; --text-col: #334155; }
        /* å·¥å…µ - æ©˜ */
        .theme-eng { --main-col: #f59e0b; --bg-col: #fef3c7; --text-col: #92400e; }

        /* Card Styles */
        .card-base { position: relative; overflow: hidden; transition: transform 0.1s; }
        .card-base:active { transform: scale(0.99); }

        /* Equipment System Card (Small Card) */
        .sys-card { 
            border-radius: 6px; 
            margin-bottom: 8px; 
            transition: all 0.2s; 
            background-color: white;
            border: 1px solid #e5e7eb; 
            border-left-width: 5px; /* Thicker left border for category color */
            border-left-color: var(--main-col); /* Use CSS variable */
        }
        .sys-card:hover { transform: translateX(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Tag Style inside Sys Card */
        .sys-tag {
            background-color: var(--bg-col);
            color: var(--text-col);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: bold;
        }

        /* Utility */
        .chevron { transition: transform 0.2s; }
        .expanded .chevron { transform: rotate(180deg); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 50px; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 500;}
        #toast.show { opacity: 1; bottom: 50px; }
        .modal-bg { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        /* Badge for task type */
        .badge-task { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .task-entry { background: #fee2e2; color: #b91c1c; }
        .task-main { background: #dbeafe; color: #1e40af; }
        .task-weekly { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="fixed top-0 left-0 right-0 z-40 bg-slate-800 shadow-xl">
        <div class="flex justify-between items-center p-3 border-b border-slate-700">
            <div class="flex gap-2 items-center">
                <span class="text-white font-bold mr-2 text-lg">è£å‚™ç®¡åˆ¶</span>
                <select id="yearInput" class="bg-slate-700 text-white font-bold text-sm px-2 py-1.5 rounded-lg border border-slate-600 outline-none focus:border-emerald-500"></select>
            </div>
            <div class="flex gap-2">
                <button onclick="openSettings()" class="bg-slate-600 text-white px-3 py-1.5 rounded-lg text-sm transition-colors hover:bg-slate-500">âš™ï¸</button>
                <button onclick="exportToCSV()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-emerald-500 shadow-lg shadow-emerald-900/20">åŒ¯å‡º</button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="grid grid-cols-3 gap-2 p-3 pb-2">
            <select id="monthFilter" class="bg-slate-700 text-white rounded-lg border border-slate-600 px-3 py-2 outline-none text-sm"></select>
            <select id="catFilter" class="bg-slate-700 text-white rounded-lg border border-slate-600 px-3 py-2 outline-none text-sm">
                <option value="all">é¡åˆ¥: å…¨éƒ¨</option>
                <option value="å…µå™¨">âš”ï¸ å…µå™¨</option>
                <option value="é€šä¿¡">ğŸ“¡ é€šä¿¡</option>
                <option value="åŒ–å­¸">ğŸ§ª åŒ–å­¸</option>
                <option value="è¼ªè»Š">ğŸšš è¼ªè»Š</option>
                <option value="å·¥å…µ">ğŸ§­ å·¥å…µ</option>
            </select>
            <select id="typeFilter" class="bg-slate-700 text-white rounded-lg border border-slate-600 px-3 py-2 outline-none text-sm"></select>
        </div>
        <div class="px-3 pb-3">
            <input type="text" id="searchInput" placeholder="æœå°‹åºè™Ÿ (ä¾‹å¦‚: 9971)..." class="w-full px-4 py-2 bg-slate-700 text-white border border-slate-600 rounded-lg outline-none focus:border-emerald-500 transition-colors placeholder-slate-400">
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="pt-[210px] max-w-2xl mx-auto p-3">
        <!-- List View -->
        <div id="cardContainer" class="space-y-4"></div>
        <div id="noData" class="hidden flex flex-col items-center justify-center mt-12 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div class="text-lg">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 modal-bg flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">âš™ï¸ ç·¨è¼¯è³‡æ–™åº«</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 space-y-4">
                <div class="text-xs text-amber-800 bg-amber-50 p-3 rounded-lg border border-amber-200 leading-relaxed">
                    âš ï¸ <b>æ³¨æ„ï¼š</b> ä¿®æ”¹å…§å®¹æœƒè‡ªå‹•å„²å­˜æ–¼æ­¤è£ç½®ã€‚è«‹ä¿æŒ JSON æ ¼å¼æ­£ç¢ºã€‚<br>è‹¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŒ‰å·¦ä¸‹è§’ã€Œæ¢å¾©é è¨­å€¼ã€ã€‚
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1 text-slate-500 uppercase tracking-wider">è£å‚™æ¸…å–® (DATA)</label>
                    <textarea id="jsonEditorData" class="w-full h-48 p-3 text-xs font-mono border rounded-lg bg-slate-50 text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1 text-slate-500 uppercase tracking-wider">å¹´åº¦æ—¥ç¨‹è¡¨ (SCHEDULE)</label>
                    <textarea id="jsonEditorSchedule" class="w-full h-32 p-3 text-xs font-mono border rounded-lg bg-slate-50 text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-between items-center">
                <button onclick="resetToDefaults()" class="text-red-500 text-xs font-bold hover:bg-red-50 px-3 py-2 rounded transition-colors">â†º æ¢å¾©é è¨­</button>
                <button onclick="saveSettings()" class="bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 shadow-md transition-transform active:scale-95">å„²å­˜ä¸¦æ‡‰ç”¨</button>
            </div>
        </div>
    </div>

    <div id="toast">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
        <span>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
    </div>

    <script>
        // --- CONFIG & CONSTANTS ---
        const CATEGORIES = {
            'å…µå™¨': { color: '#ef4444', css: 'theme-weap' }, // Red
            'é€šä¿¡': { color: '#0ea5e9', css: 'theme-comm' }, // Blue
            'åŒ–å­¸': { color: '#14b8a6', css: 'theme-chem' }, // Teal
            'è¼ªè»Š': { color: '#64748b', css: 'theme-truck' }, // Slate
            'å·¥å…µ': { color: '#f59e0b', css: 'theme-eng' }   // Amber
        };

        const DEFAULT_DATA = {
            T74: { name: 'T74 æ’ç”¨æ©Ÿæ§', cat: 'å…µå™¨', ids: '007231,007447,007496,007501,007544,007654,009661,009971', groups: [1,1,2,2,2,3,3,3] },
            T75: { name: 'T75 ç­ç”¨æ©Ÿæ§', cat: 'å…µå™¨', ids: '008727,008749,008788,008805,008870,008899,008950,009043,009097,009109,012244,012247,012459,012610,012627,012864,012865,012880,012919,012925,012928,012931,012933,012943,012946,012954,012959,012962,012964,012967,013026,013029,013031,013032,013038,013039', groups: Array(36).fill(0).map((_, i) => i < 18 ? 'A' : 'B') },
            T65K2: { name: 'T65K2 æ­¥æ§', cat: 'å…µå™¨', ids: '186074,187921,193648,207145,209263,209439,209697,209823,219834,220007,221303,221554,221566,221640,224376,230470,231016,231849,232622,234718,234742,236236,236465,236967,237338,314846,332587,332607,332668,332754,332762,337624,362245,362411,362415,362676,363053,364122,364896,367128,367730,368657,369550,370013,370200,370374,383020,383715,385207,385332,386038,386251,386399,388131,389145,389516,390010,390539,391124,391958,392012,392166,392167,393872,393947,394347,394468,394681,394777,394861,394863,394902,394907,394913,394923,395042,395065,395109,395113,395167,395348,395555,395671,395860,396172,396176,396207,396356,396359,396597,397068,397153,397273,397314,398005,398192,398389,398432,398934,399146,399327,399595,400655,400847,401766,402894,403128,403843,404390,405120,405205,405700,406970,407492,407620,408250' },
            T85: { name: 'T85 æ¦´å½ˆç™¼å°„å™¨', cat: 'å…µå™¨', ids: '000032,000155,001750,001780,001998,008454,008834,008890,009004,009759,010532,010681,011186,011293,011358,011498,011522,011662,011820,011906,012571,012589,012695,012760,012775,012845,014580,016641,018164,018390,019120,019191,019202,019261,019674,021606' },
            M1911A1: { name: 'M1911A1 æ‰‹æ§', cat: 'å…µå™¨', ids: '51-06411' },
            M1911: { name: 'M1911 æ‰‹æ§', cat: 'å…µå™¨', ids: '124141,1546783,1810911,1943969,1952496,2215347,2226406,954710' },
            M8A1: { name: 'M8A1 æ¯’æ°£è­¦å ±å™¨', cat: 'åŒ–å­¸', ids: '1010413' },
            'LS-920': { name: 'LS-920 æ¶ˆæ¯’å™¨', cat: 'åŒ–å­¸', ids: '513,514' },
            'T3-75': { name: 'T3-75 é˜²æ¯’é¢å…·', cat: 'åŒ–å­¸', bulk: 161 },
            M256: { name: 'M256 åµæª¢åŒ…', cat: 'åŒ–å­¸', bulk: 1 },
            WAR_FILTER: { name: 'æˆ°å‚™æ¿¾æ¯’ç½', cat: 'åŒ–å­¸', bulk: 161 },
            '62_FILTER': { name: '62å¼æ¿¾æ¯’ç½', cat: 'åŒ–å­¸', bulk: 161 },
            'T4-86': { name: 'T4-86 æ¶ˆé™¤åŒ…', cat: 'åŒ–å­¸', bulk: 161 },
            'MHR-112': { name: 'MHR-112 ç„¡ç·šé›»æ©Ÿ', cat: 'é€šä¿¡', ids: 'LV11203353,LV11203354,LV11203355,LV11203356,LV11203357,LV11203358,LV11203359,LV11203360,LV11203361,LV11203362,LV11203363,LV11203364,LV11203365,LV11203366,LV11203367,LV11203368,LV11203369,LV11203370,LV11203371,LV11203372,LV11203373' },
            'PRC-37C': { name: 'CS/PRC-37C ç„¡ç·šé›»æ©Ÿ', cat: 'é€šä¿¡', ids: '22250' },
            'KY-2000A': { name: 'KY-2000A é›»å­è©±æ©Ÿ', cat: 'é€šä¿¡', ids: '714-T02378,714-T02422,714-T02628,714-T02647,714-T03864,714-T13385,714-T13867,714-T13873,714-T14184,714-T14238,714-T15582,714-T15596,714-T14095,714-T17758,714-T17764' },
            TRUCK: { name: '3.5å™¸è¼‰é‡è»Š', cat: 'è¼ªè»Š', ids: 'è»3-23993' },
            COMPASS: { name: 'æŒ‡åŒ—é‡', cat: 'å·¥å…µ', ids: 'V-109J-0D07-0374,900288,9105443,9100940' },
            TS71: { name: 'TS-71 å…«å€æœ›é é¡', cat: 'å·¥å…µ', ids: '920593,920594,930926,931142,931501,931863,94A031182,94A030419,94A030713' }
        };

        const DEFAULT_SCHEDULE = {1:{m:19,t:20,w:21,f:23},2:{m:23,t:24,w:25,f:27},3:{m:23,t:24,w:25,f:27},4:{m:20,t:21,w:22,f:24},5:{m:25,t:26,w:27,f:29},6:{m:22,t:23,w:24,f:26},7:{m:20,t:21,w:22,f:24},8:{m:24,t:25,w:26,f:28},9:{m:21,t:22,w:23,f:25},10:{m:19,t:20,w:21,f:23},11:{m:23,t:24,w:25,f:27},12:{m:21,t:22,w:23,f:25}};

        let DATA = {}, SCHEDULE = {};
        let allData = [], filteredData = [], currentYear = 115;

        // --- CORE FUNCTIONS ---
        function loadData() {
            const savedData = localStorage.getItem('MY_EQUIP_DATA');
            const savedSched = localStorage.getItem('MY_SCHEDULE');
            DATA = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(DEFAULT_DATA));
            SCHEDULE = savedSched ? JSON.parse(savedSched) : JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));

            Object.keys(DATA).forEach(k => {
                if (DATA[k].ids && !DATA[k].list) DATA[k].list = DATA[k].ids.split(',');
            });
        }

        // å„ªåŒ–æ—¥æœŸè¨ˆç®—
        function getWorkDay(y, m, n) {
            let d = new Date(y, m-1, 1), c = 0;
            while (d.getMonth() === m-1) {
                const day = d.getDay();
                if (day !== 0 && day !== 6) {
                    c++;
                    if (c === n) return d;
                }
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        function getWeekday(y, m, n, wd) {
            let d = new Date(y, m-1, 1), c = 0;
            while (d.getMonth() === m-1) {
                if (d.getDay() === wd) {
                    c++;
                    if (c === n) return d;
                }
                d.setDate(d.getDate() + 1);
            }
            return null;
        }

        function getFridays(y, m) {
            let r = [], d = new Date(y, m-1, 1);
            while (d.getMonth() === m-1) {
                if (d.getDay() === 5) r.push(new Date(d));
                d.setDate(d.getDate() + 1);
            }
            return r;
        }

        function fmt(d) {
            const m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
            return { str: `${m}.${day}`, day: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()], key: parseInt(`${d.getFullYear()}${m}${day}`), obj: d };
        }

        function buildSchedule() {
            let rawEvents = [];
            const y = currentYear + 1911;
            
            for (let m = 1; m <= 12; m++) {
                const s = SCHEDULE[m];
                if (!s) continue; 
                
                const mainMon = new Date(y, m-1, s.m);
                const mainTue = new Date(y, m-1, s.t);
                const mainWed = new Date(y, m-1, s.w);
                const mainFriKey = fmt(new Date(y, m-1, s.f)).key;
                const wd1 = getWorkDay(y, m, 1);
                const wd2 = getWorkDay(y, m, 2);
                
                const add = (d, t, sys, filterFn) => {
                    const sysData = DATA[sys];
                    if(!sysData) return;
                    let ids = sysData.list || [];
                    if(filterFn) ids = ids.filter(filterFn);
                    
                    rawEvents.push({ m, d: fmt(d), t, sys, cat: sysData.cat, ids, bulk: sysData.bulk });
                };

                // Schedule Rules
                const eg = m % 3 || 3;
                add(wd1, 'é€²å» ', 'T74', (_, i) => DATA.T74.groups[i] === eg);
                add(mainWed, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', 'T74', (_, i) => DATA.T74.groups[i] !== eg);
                add(wd1, 'é€²å» ', 'T75', (_, i) => DATA.T75.groups[i] === 'A');
                add(wd2, 'é€²å» ', 'T75', (_, i) => DATA.T75.groups[i] === 'B');
                add(mainWed, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', 'T65K2');
                const w1f = getWeekday(y, m, 1, 5);
                if (w1f && fmt(w1f).key !== mainFriKey) add(w1f, `${m}æœˆç¬¬1é€±é€±ä¿é¤Š`, 'T65K2');
                ['T85','M1911A1','M1911'].forEach(s => add(mainWed, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', s));
                ['TRUCK', 'COMPASS', 'TS71', 'KY-2000A'].forEach(s => add(mainTue, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', s));
                ['MHR-112','PRC-37C'].forEach(s => { add(wd1, 'é€²å» ', s); add(mainTue, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', s); });
                ['M8A1','LS-920'].forEach(s => { add(wd2, 'é€²å» ', s); add(mainMon, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', s); });
                ['T3-75','M256','WAR_FILTER','62_FILTER','T4-86'].forEach(s => add(mainMon, 'é€£ä¸»å®˜è£å‚™æª¢æŸ¥', s));
                getFridays(y, m).forEach(f => {
                    if (fmt(f).key === mainFriKey) return;
                    const w = Math.ceil(f.getDate() / 7);
                    ['M8A1','LS-920','MHR-112','PRC-37C','KY-2000A','TRUCK'].forEach(s => add(f, `${m}æœˆç¬¬${w}é€±é€±ä¿é¤Š`, s));
                });
            }
            
            const groupedMap = new Map();
            rawEvents.forEach(e => {
                const k = `${e.d.key}_${e.t}`;
                if (!groupedMap.has(k)) {
                    groupedMap.set(k, {
                        m: e.m, d: e.d, t: e.t,
                        items: [],
                        cats: new Set(),
                        totalCount: 0
                    });
                }
                const group = groupedMap.get(k);
                group.items.push({ sys: e.sys, ids: e.ids, bulk: e.bulk, cat: e.cat });
                group.cats.add(e.cat);
                group.totalCount += (e.bulk || (e.ids ? e.ids.length : 0));
            });

            allData = Array.from(groupedMap.values()).sort((a, b) => a.d.key - b.d.key);
        }

        // --- RENDER LOGIC ---
        function filter() {
            const mf = document.getElementById('monthFilter').value;
            const cf = document.getElementById('catFilter').value;
            const tf = document.getElementById('typeFilter').value;
            const q = document.getElementById('searchInput').value.trim();
            
            filteredData = allData.filter(row => {
                if (mf !== 'all' && row.m != mf) return false;
                if (tf !== 'all' && (tf === 'é€±ä¿é¤Š' ? !row.t.includes('é€±ä¿é¤Š') : row.t !== tf)) return false;
                
                const hasMatchingItem = row.items.some(it => {
                    if (cf !== 'all' && it.cat !== cf) return false;
                    if (q && it.ids && !it.ids.some(id => id.includes(q))) return false;
                    return true;
                });
                return hasMatchingItem;
            });

            renderList(q, cf);
        }

        function renderList(searchQuery, catFilter) {
            const container = document.getElementById('cardContainer');
            const noData = document.getElementById('noData');
            container.innerHTML = '';
            
            if (filteredData.length === 0) {
                noData.classList.remove('hidden');
                return;
            }
            noData.classList.add('hidden');
            
            const fragment = document.createDocumentFragment();

            filteredData.forEach((row, i) => {
                const taskTypeClass = row.t === 'é€²å» ' ? 'task-entry' : row.t.includes('é€£ä¸»å®˜') ? 'task-main' : 'task-weekly';
                
                const catsArray = Array.from(row.cats);
                const catSummaryStr = catsArray.map(c => c[0]).join('');
                const summaryHtml = `
                    <span class="font-bold text-slate-700 mr-1">${catSummaryStr}</span>
                    <span class="text-slate-500">${row.cats.size}é¡ ${row.items.length}é … ${row.totalCount}ä»¶</span>
                `;

                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm mb-4 card-base border border-slate-200`;
                
                let innerHtml = `
                    <div class="p-4">
                        <div class="flex justify-between mb-3 items-start">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <div class="text-xl font-bold text-slate-800">${row.d.str} <span class="text-sm font-normal text-slate-500">(${row.d.day})</span></div>
                                    <span class="badge-task ${taskTypeClass}">${row.t}</span>
                                </div>
                                <div class="text-xs bg-slate-100 px-2 py-1 rounded w-fit flex items-center gap-1 border border-slate-200">
                                    ${summaryHtml}
                                </div>
                            </div>
                            <button onclick="copy(${i})" class="text-slate-400 hover:text-emerald-600 transition-colors p-1.5 rounded-full hover:bg-emerald-50 active:scale-90" title="è¤‡è£½æ¸…å–®">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                            </button>
                        </div>
                `;

                row.items.forEach((it, idx) => {
                    if(catFilter !== 'all' && it.cat !== catFilter) return;

                    const cnt = it.bulk || (it.ids ? it.ids.length : 0);
                    const rowId = `sys-${i}-${idx}`;
                    const shouldExpand = searchQuery && it.ids && it.ids.some(id => id.includes(searchQuery));
                    const catTheme = CATEGORIES[it.cat] || { css: 'theme-truck' }; 

                    innerHtml += `
                        <div id="row-${rowId}" class="sys-card ${catTheme.css} ${shouldExpand ? 'expanded' : ''} cursor-pointer relative" onclick="toggleSys('${rowId}')">
                            <div class="flex justify-between items-center p-2.5">
                                <div class="flex items-center gap-3">
                                    <!-- è£å‚™åç¨± -->
                                    <span class="font-bold text-sm text-slate-700">${DATA[it.sys].name}</span>
                                    <!-- é¡åˆ¥æ¨™ç±¤ (ä½¿ç”¨ CSS è®Šæ•¸ä¸Šè‰²) -->
                                    <span class="sys-tag">${it.cat} ${cnt}ä»¶</span>
                                </div>
                                <div class="text-slate-400 chevron" id="icon-${rowId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                            <div id="list-${rowId}" class="${shouldExpand ? '' : 'hidden'} px-3 pb-3 pt-1 border-t border-dashed border-slate-200">
                    `;
                    
                    if (it.bulk) {
                        innerHtml += `<div class="text-xs text-slate-500 italic bg-slate-50 p-2 rounded">æ‰¹é‡ç®¡åˆ¶ (ç„¡å€‹åˆ¥åºè™Ÿ)</div>`;
                    } else if (it.ids && it.ids.length > 0) {
                        innerHtml += `<div class="flex flex-wrap gap-1.5 mt-1">`;
                        it.ids.forEach(id => {
                            const match = searchQuery && id.includes(searchQuery);
                            const style = match ? 'bg-amber-100 border-amber-300 text-amber-900 font-bold ring-2 ring-amber-200' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300';
                            innerHtml += `<span class="${style} border px-2 py-0.5 rounded text-xs font-mono transition-all">${id}</span>`;
                        });
                        innerHtml += `</div>`;
                    } else {
                         innerHtml += `<div class="text-xs text-slate-400 italic">ç„¡è³‡æ–™</div>`;
                    }
                    innerHtml += `</div></div>`;
                });
                
                innerHtml += `</div>`;
                card.innerHTML = innerHtml;
                fragment.appendChild(card);
            });
            
            container.appendChild(fragment);
        }

        // --- UI INTERACTION ---
        window.toggleSys = function(id) {
            const content = document.getElementById(`list-${id}`);
            const row = document.getElementById(`row-${id}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                row.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                row.classList.remove('expanded');
            }
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('jsonEditorData').value = JSON.stringify(DATA, null, 2);
            document.getElementById('jsonEditorSchedule').value = JSON.stringify(SCHEDULE, null, 2);
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            try {
                const newData = JSON.parse(document.getElementById('jsonEditorData').value);
                const newSched = JSON.parse(document.getElementById('jsonEditorSchedule').value);
                localStorage.setItem('MY_EQUIP_DATA', JSON.stringify(newData));
                localStorage.setItem('MY_SCHEDULE', JSON.stringify(newSched));
                alert('è¨­å®šå·²å„²å­˜ï¼');
                location.reload();
            } catch (e) {
                alert('JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å…§å®¹ï¼\n' + e);
            }
        }

        function resetToDefaults() {
            if(confirm('ç¢ºå®šè¦æ¢å¾©é è¨­å€¼å—ï¼Ÿ')) {
                localStorage.removeItem('MY_EQUIP_DATA');
                localStorage.removeItem('MY_SCHEDULE');
                location.reload();
            }
        }

        // --- UTILS ---
        window.copy = function(i) {
            const row = filteredData[i];
            const catsArr = Array.from(row.cats);
            let txt = `ğŸ“… ${currentYear}/${row.d.str.replace('.','/')} (${row.d.day})\nğŸ“ ä»»å‹™ï¼š${row.t}\nğŸ“Š çµ±è¨ˆï¼š${catsArr.join('')} ${row.cats.size}é¡ ${row.items.length}é … ${row.totalCount}ä»¶\n${'â”€'.repeat(24)}\n`;
            row.items.forEach((it, j) => {
                const cnt = it.bulk || it.ids.length;
                txt += `${j+1}. [${it.cat}] ${DATA[it.sys].name} (${cnt}ä»¶)\n`;
                if (it.ids) txt += `   åºè™Ÿ: ${it.ids.join(', ')}\n`;
            });
            navigator.clipboard.writeText(txt).then(() => {
                const t = document.getElementById('toast');
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            });
        }

        window.exportToCSV = function() {
            let csv = '\uFEFFYear,Month,Date,Day,Task,Category,System,Count,IDs\n';
            allData.forEach(row => {
                row.items.forEach(it => {
                    const ids = it.bulk ? `æ‰¹é‡${it.bulk}ä»¶` : it.ids.join(';');
                    csv += `${currentYear},${row.m},${row.d.str},${row.d.day},${row.t},${it.cat},${DATA[it.sys].name},${it.bulk||it.ids.length},"${ids}"\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è£å‚™ç®¡åˆ¶æ¸…å†Š_${currentYear}å¹´.csv`;
            a.click();
        }

        // --- INIT ---
        loadData();
        
        const ysel = document.getElementById('yearInput');
        for (let y = 115; y <= 125; y++) {
            const opt = document.createElement('option');
            opt.value = opt.text = y;
            if (y === 115) opt.selected = true;
            ysel.appendChild(opt);
        }

        const msel = document.getElementById('monthFilter');
        msel.innerHTML = '<option value="all">æœˆä»½: å…¨éƒ¨</option>';
        for (let i = 1; i <= 12; i++) msel.innerHTML += `<option value="${i}">${i}æœˆ</option>`;

        document.getElementById('typeFilter').innerHTML = '<option value="all">ä»»å‹™: å…¨éƒ¨</option><option value="é€²å» ">ğŸ”´ é€²å» </option><option value="é€£ä¸»å®˜è£å‚™æª¢æŸ¥">ğŸ”µ é€£ä¸»æª¢</option><option value="é€±ä¿é¤Š">ğŸŸ¢ é€±ä¿é¤Š</option>';

        ysel.onchange = (e) => { currentYear = +e.target.value; buildSchedule(); filter(); };
        
        let debounceTimer;
        document.getElementById('searchInput').oninput = (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(filter, 300);
        };
        
        ['catFilter', 'typeFilter', 'monthFilter'].forEach(id => {
            document.getElementById(id).onchange = filter;
        });

        buildSchedule();
        filter();
    </script>
</body>
</html>

